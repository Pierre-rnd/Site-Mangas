<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestionnaire de Mangas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        function toggleForm() {
            var form = document.getElementById('mangaForm');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
                form.reset(); 
            }
        }
    </script>
    <script>
    function showToast(message, type) {
        type = type || 'success';
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(function() { toast.classList.add('show'); });
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() { toast.remove(); }, 300);
        }, 2800);
    }
    function supprimerManga(index) {
        if (confirm("ÃŠtes-vous sÃ»r de vouloir supprimer ce manga ?")) {
            fetch(`/supprimer/${index}`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Manga supprimÃ©');
                    setTimeout(function() { window.location.reload(); }, 1200);
                } else {
                    alert('Erreur : impossible de supprimer le manga.');
                }
            })
            .catch(function() { alert('Erreur : impossible de contacter le serveur.'); });
        }
    }</script>
    <script>
        function modifierChapitre(index, change) {
            fetch(`/modifier_chapitre/${index}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ change: change })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`chapitre-${index}`).textContent = data.nouveauChapitre;
            })
            .catch(error => console.error('Erreur:', error));
        }
    </script>
    <style>
        .stars {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            cursor: pointer;
        }

        .stars input[type="radio"] {
            display: none;
        }

        .stars label {
            font-size: 1.5em;
            color: #ccc;
        }

        .stars input[type="radio"]:checked ~ label,
        .stars label:hover,
        .stars label:hover ~ label {
            color: #f5b301;
        }
    </style>
</head>
<h1>Gestionnaire de Mangas</h1>

<body>
    <div id="toast-container" class="toast-container" aria-live="polite"></div>
    <form method="GET" action="/" class="filter-form">
        <label for="search">Rechercher</label>
        <input type="text" id="search" name="search" value="{{ request.args.get('search', '') }}" placeholder="Nom du manga..." title="Raccourci : S">
        
        <label for="filter-fini">Statut</label>
        <select id="filter-fini" name="filter_fini">
            <option value="">Tous</option>
            <option value="oui" {% if request.args.get('filter_fini') == 'oui' %}selected{% endif %}>TerminÃ©s</option>
            <option value="non" {% if request.args.get('filter_fini') == 'non' %}selected{% endif %}>En cours</option>
        </select>
        
        <label for="filter-note">Note</label>
        <select id="filter-note" name="filter_note">
            <option value="">Toutes</option>
            {% for i in range(1, 6) %}
            <option value="{{ i }}" {% if request.args.get('filter_note') == i|string %}selected{% endif %}>{{ i }} â˜…</option>
            {% endfor %}
        </select>

        <label for="sort">Trier par</label>
        <select id="sort" name="sort" onchange="this.form.submit()">
            <option value="nom" {% if request.args.get('sort', sort|default('nom')) == 'nom' %}selected{% endif %}>Nom (Aâ†’Z)</option>
            <option value="note" {% if request.args.get('sort') == 'note' %}selected{% endif %}>Note (â†‘)</option>
            <option value="derniere_lecture" {% if request.args.get('sort') == 'derniere_lecture' %}selected{% endif %}>DerniÃ¨re lecture</option>
            <option value="chapitre" {% if request.args.get('sort') == 'chapitre' %}selected{% endif %}>Chapitre (â†‘)</option>
        </select>
        
        <button type="submit">Filtrer</button>
        <a href="/" class="button button-outline">RÃ©initialiser</a>
    </form>
    <p class="results-count">{{ mangas|length }} manga{{ 's' if mangas|length != 1 else '' }} affichÃ©{{ 's' if mangas|length != 1 else '' }}</p>

    <div class="toolbar">
        <button onclick="toggleForm()" class="btn-add-toggle" id="btn-add-manga" title="Raccourci : N">+ Ajouter un manga</button>
        <div class="view-toggle" role="group" aria-label="Vue">
            <button type="button" class="view-btn active" data-view="grid" title="Vue grille">âŠž</button>
            <button type="button" class="view-btn" data-view="list" title="Vue liste">â‰¡</button>
        </div>
    </div>
    
    <form id="mangaForm" action="/ajouter" method="post" class="form-add-manga" style="display:none;">
        <label for="nom">Nom du Manga:</label>
        <input type="text" id="nom" name="nom" required><br>
        
        <label for="chapitre">Chapitre actuel:</label>
        <input type="text" id="chapitre" name="chapitre" required><br>
        
        <label for="saison">Saison actuelle:</label>
        <input type="text" id="saison" name="saison" required><br>
        
        <label for="fini">Est-ce que le manga est fini?</label>
        <select id="fini" name="fini">
            <option value="oui">Oui</option>
            <option value="non">Non</option>
        </select><br>
        
        <label for="lien">Lien vers la page pour lire le manga:</label>
        <input type="url" id="lien" name="lien" required><br>
        
        <label for="note">Note:</label>
        <div class="stars">
            <input type="radio" id="star5" name="note" value="5" />
            <label for="star5"><i class="fas fa-star"></i></label>
            <input type="radio" id="star4" name="note" value="4" />
            <label for="star4"><i class="fas fa-star"></i></label>
            <input type="radio" id="star3" name="note" value="3" />
            <label for="star3"><i class="fas fa-star"></i></label>
            <input type="radio" id="star2" name="note" value="2" />
            <label for="star2"><i class="fas fa-star"></i></label>
            <input type="radio" id="star1" name="note" value="1" />
            <label for="star1"><i class="fas fa-star"></i></label>
        </div><br>
        <label for="image">Lien de l'image:</label>
        <input type="url" id="image" name="image" required><br>
        <button type="submit">Ajouter Manga</button>
    </form>
    
    <div class="manga-cards" id="manga-cards">
        {% if not mangas %}
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ“š</div>
            <h2>Aucun manga trouvÃ©</h2>
            <p>Modifiez les filtres ou ajoutez un nouveau manga pour commencer.</p>
            <button onclick="toggleForm()" class="button">Ajouter un manga</button>
        </div>
        {% else %}
        {% for manga in mangas %}
        <div class="manga-card" style="animation-delay: {{ loop.index0 * 0.06 }}s">
            {% if manga.non_lu %}
            <div class="badge-non-lu">Non lu depuis 1 semaine</div>
            {% endif %}
            <img src="{{ manga.image }}" alt="{{ manga.nom }}" loading="lazy" onerror="this.onerror=null; this.classList.add('img-fallback'); this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';">
            <div class="manga-details">
                <h3>{{ manga.nom }}</h3>
                <p class="chapter-row">Chapitre :</p>
                <div class="chapter-controls">
                    <button type="button" class="chapter-btn" onclick="modifierChapitre('{{ manga.id }}', -1)" aria-label="Diminuer le chapitre">âˆ’</button>
                    <span id="chapitre-{{ manga.id }}">{{ manga.chapitre }}</span>
                    <button type="button" class="chapter-btn" onclick="modifierChapitre('{{ manga.id }}', 1)" aria-label="Augmenter le chapitre">+</button>
                </div>
                <p>Saison : {{ manga.saison }}</p>
                <p class="last-read" title="DerniÃ¨re lecture">ðŸ“… {{ manga.last_read_label }}</p>
                <p>Statut : <span class="{{ 'status-termine' if manga.fini else 'status-cours' }}">{{ 'TerminÃ©' if manga.fini else 'En cours' }}</span></p>
                <p><a href="{{ url_for('lire_manga', id=manga.id) }}" target="_blank" class="link-read">Lire le manga</a></p>
                <p>Note: {% for i in range(1, 6) %}
                    {% if i <= manga.note %}
                        &#9733;
                    {% else %}
                        &#9734;
                    {% endif %}
                {% endfor %}</p>
                <p><a href="{{ url_for('editer', id=manga.id) }}">Modifier</a> </p>
                <button class="delete-btn" onclick="supprimerManga('{{ manga.id }}')">Supprimer</button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

<button id="stats-btn" title="Voir les statistiques">ðŸ“Š</button>
<div id="stats-overlay">
    <div id="stats-panel">
        <span id="close-stats">&times;</span>
        <h2>Statistiques du site</h2>
        <div id="stats-content">
            <p><strong>Total de mangas :</strong> <span id="total"></span></p>
            <p><strong>Mangas terminÃ©s :</strong> <span id="finis"></span></p>
            <p><strong>Mangas en cours :</strong> <span id="en_cours"></span></p>
            <p><strong>Non lus depuis 7+ jours :</strong> <span id="non_lu_7j"></span></p>
            <p><strong>Note moyenne :</strong> <span id="moyenne"></span></p>
            <p><strong>Meilleur manga :</strong> <span id="meilleur"></span></p>
        </div>
    </div>
</div>

<script>
  const statsBtn = document.getElementById('stats-btn');
  const overlay = document.getElementById('stats-overlay');
  const closeBtn = document.getElementById('close-stats');

  async function openStats() {
    try {
      const res = await fetch('/stats');
      if (!res.ok) throw new Error('Erreur rÃ©seau');
      const data = await res.json();
      document.getElementById('total').textContent = data.total ?? '0';
      document.getElementById('finis').textContent = data.finis ?? '0';
      document.getElementById('en_cours').textContent = data.en_cours ?? '0';
      document.getElementById('non_lu_7j').textContent = data.non_lu_7j ?? '0';
      document.getElementById('moyenne').textContent = data.moyenne ?? '0';
      document.getElementById('meilleur').textContent = (data.meilleur_nom ? `${data.meilleur_nom} (${data.meilleur_note}â˜…)` : 'â€”');
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
    } catch (err) {
      console.error('Impossible de charger les stats :', err);
      alert("Impossible de rÃ©cupÃ©rer les statistiques. VÃ©rifie la route /stats cÃ´tÃ© serveur.");
    }
  }

  statsBtn.addEventListener('click', openStats);
  closeBtn.addEventListener('click', () => {
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.classList.contains('show')) {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }
  });

  // Toasts au chargement (aprÃ¨s ajout / modification)
  (function() {
    var params = new URLSearchParams(window.location.search);
    var clean = false;
    if (params.get('added') === '1') {
      showToast('Manga ajoutÃ©');
      params.delete('added');
      clean = true;
    }
    if (params.get('updated') === '1') {
      showToast('Modifications enregistrÃ©es');
      params.delete('updated');
      clean = true;
    }
    if (clean) {
      var q = params.toString();
      history.replaceState({}, '', window.location.pathname + (q ? '?' + q : ''));
    }
  })();

  // Raccourcis clavier
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey || e.altKey) return;
    var tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
    if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
    if (e.key === 'n' || e.key === 'N') {
      e.preventDefault();
      toggleForm();
    }
    if (e.key === 's' || e.key === 'S') {
      e.preventDefault();
      document.getElementById('search').focus();
    }
    if (e.key === 'Escape') {
      var form = document.getElementById('mangaForm');
      if (form && form.style.display === 'block') {
        toggleForm();
      }
    }
  });

  // Bascule vue grille / liste
  document.querySelectorAll('.view-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.view-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var list = document.getElementById('manga-cards');
      if (btn.getAttribute('data-view') === 'list') {
        list.classList.add('view-list');
      } else {
        list.classList.remove('view-list');
      }
    });
  });
</script>


</body>
</html>
