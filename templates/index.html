<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestionnaire de Mangas{% if mangas and mangas|length > 0 %} ({{ mangas|length }}){% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        function toggleForm() {
            var overlay = document.getElementById('add-overlay');
            if (overlay.classList.contains('show')) {
                overlay.classList.remove('show');
                document.getElementById('mangaForm').reset();
            } else {
                overlay.classList.add('show');
            }
        }
    </script>
    <script>
    function showToast(message, type) {
        type = type || 'success';
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(function() { toast.classList.add('show'); });
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() { toast.remove(); }, 300);
        }, 2800);
    }
    var deleteModalId = null;
    function supprimerManga(id) {
        deleteModalId = id;
        document.getElementById('delete-overlay').classList.add('show');
    }
    function closeDeleteModal() {
        deleteModalId = null;
        document.getElementById('delete-overlay').classList.remove('show');
    }
    function confirmDelete() {
        if (!deleteModalId) return;
        var id = deleteModalId;
        closeDeleteModal();
        fetch('/supprimer/' + id, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            .then(function(r) {
                if (r.ok) {
                    showToast('Manga supprim√©');
                    setTimeout(function() { window.location.reload(); }, 1200);
                } else { alert('Erreur : impossible de supprimer le manga.'); }
            })
            .catch(function() { alert('Erreur : impossible de contacter le serveur.'); });
    }
    function copyReadLink(btn) {
        var url = btn.getAttribute('data-url');
        if (!url) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(function() { showToast('Lien copi√©'); }).catch(function() { showToast('√âchec de la copie', 'error'); });
        } else {
            var ta = document.createElement('textarea'); ta.value = url; ta.style.position = 'fixed'; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('Lien copi√©'); } catch (e) { showToast('√âchec de la copie', 'error'); }
            document.body.removeChild(ta);
        }
    }
</script>
    <script>
        function modifierChapitre(index, change) {
            var el = document.getElementById('chapitre-' + index);
            var card = el && el.closest('.manga-card');
            var btns = card ? card.querySelectorAll('.chapter-btn') : [];
            btns.forEach(function(b) { b.disabled = true; b.classList.add('loading'); });
            fetch('/modifier_chapitre/' + index, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ change: change })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (el) el.textContent = data.nouveauChapitre;
                btns.forEach(function(b) { b.disabled = false; b.classList.remove('loading'); });
            })
            .catch(function(err) {
                console.error('Erreur:', err);
                btns.forEach(function(b) { b.disabled = false; b.classList.remove('loading'); });
            });
        }
    </script>
    <style>
        .stars {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            cursor: pointer;
        }

        .stars input[type="radio"] {
            display: none;
        }

        .stars label {
            font-size: 1.5em;
            color: #ccc;
        }

        .stars input[type="radio"]:checked ~ label,
        .stars label:hover,
        .stars label:hover ~ label {
            color: #f5b301;
        }
    </style>
</head>
<h1>Gestionnaire de Mangas</h1>

<body>
    <div id="toast-container" class="toast-container" aria-live="polite"></div>
    <form method="GET" action="/" class="filter-form">
        <label for="search">Rechercher</label>
        <input type="text" id="search" name="search" value="{{ request.args.get('search', '') }}" placeholder="Nom du manga..." title="Raccourci : S">
        
        <label for="filter-fini">Statut</label>
        <select id="filter-fini" name="filter_fini">
            <option value="">Tous</option>
            <option value="oui" {% if request.args.get('filter_fini') == 'oui' %}selected{% endif %}>Termin√©s</option>
            <option value="non" {% if request.args.get('filter_fini') == 'non' %}selected{% endif %}>En cours</option>
        </select>
        
        <label for="filter-note">Note</label>
        <select id="filter-note" name="filter_note">
            <option value="">Toutes</option>
            {% for i in range(1, 6) %}
            <option value="{{ i }}" {% if request.args.get('filter_note') == i|string %}selected{% endif %}>{{ i }} ‚òÖ</option>
            {% endfor %}
        </select>

        <label for="sort">Trier par</label>
        <select id="sort" name="sort" onchange="this.form.submit()">
            <option value="nom" {% if request.args.get('sort', sort|default('nom')) == 'nom' %}selected{% endif %}>Nom (A‚ÜíZ)</option>
            <option value="note" {% if request.args.get('sort') == 'note' %}selected{% endif %}>Note (‚Üë)</option>
            <option value="derniere_lecture" {% if request.args.get('sort') == 'derniere_lecture' %}selected{% endif %}>Derni√®re lecture</option>
            <option value="chapitre" {% if request.args.get('sort') == 'chapitre' %}selected{% endif %}>Chapitre (‚Üë)</option>
        </select>
        <label for="order">Ordre</label>
        <select id="order" name="order" onchange="this.form.submit()">
            <option value="asc" {% if request.args.get('order', order|default('asc')) == 'asc' %}selected{% endif %}>‚Üë Ascendant</option>
            <option value="desc" {% if request.args.get('order') == 'desc' %}selected{% endif %}>‚Üì Descendant</option>
        </select>
        <label class="filter-checkbox">
            <input type="checkbox" name="non_lu" value="1" {% if request.args.get('non_lu') == '1' %}checked{% endif %}>
            <span>Non lus 7j+</span>
        </label>
        <button type="submit">Filtrer</button>
        <a href="/" class="button button-outline">R√©initialiser</a>
    </form>
    {% set q = request.args %}
    {% if q.get('search') or q.get('filter_fini') or q.get('filter_note') or q.get('non_lu') %}
    <div class="active-filters">
        {% if q.get('search') %}<a href="{{ url_for('index', search='', filter_fini=q.get('filter_fini'), filter_note=q.get('filter_note'), non_lu=q.get('non_lu'), sort=q.get('sort'), order=q.get('order')) }}" class="filter-tag">¬´ {{ q.get('search') }} ¬ª √ó</a>{% endif %}
        {% if q.get('filter_fini') == 'oui' %}<a href="{{ url_for('index', search=q.get('search'), filter_fini='', filter_note=q.get('filter_note'), non_lu=q.get('non_lu'), sort=q.get('sort'), order=q.get('order')) }}" class="filter-tag">Termin√©s √ó</a>{% endif %}
        {% if q.get('filter_fini') == 'non' %}<a href="{{ url_for('index', search=q.get('search'), filter_fini='', filter_note=q.get('filter_note'), non_lu=q.get('non_lu'), sort=q.get('sort'), order=q.get('order')) }}" class="filter-tag">En cours √ó</a>{% endif %}
        {% if q.get('filter_note') %}<a href="{{ url_for('index', search=q.get('search'), filter_fini=q.get('filter_fini'), filter_note='', non_lu=q.get('non_lu'), sort=q.get('sort'), order=q.get('order')) }}" class="filter-tag">Note {{ q.get('filter_note') }} ‚òÖ √ó</a>{% endif %}
        {% if q.get('non_lu') == '1' %}<a href="{{ url_for('index', search=q.get('search'), filter_fini=q.get('filter_fini'), filter_note=q.get('filter_note'), non_lu='', sort=q.get('sort'), order=q.get('order')) }}" class="filter-tag">Non lus 7j+ √ó</a>{% endif %}
    </div>
    {% endif %}
    <p class="results-count">{{ mangas|length }} manga{{ 's' if mangas|length != 1 else '' }} affich√©{{ 's' if mangas|length != 1 else '' }}</p>

    <div class="toolbar">
        <button onclick="toggleForm()" class="btn-add-toggle" id="btn-add-manga" title="Raccourci : N">+ Ajouter un manga</button>
        <a href="{{ url_for('export_json') }}" class="button button-export" download title="Sauvegarde JSON">üì• JSON</a>
        <a href="{{ url_for('export_csv') }}" class="button button-export" download title="Sauvegarde CSV (Excel)">üì• CSV</a>
        <div class="view-toggle" role="group" aria-label="Vue">
            <button type="button" class="view-btn active" data-view="grid" title="Vue grille">‚äû</button>
            <button type="button" class="view-btn" data-view="list" title="Vue liste">‚â°</button>
        </div>
        <button type="button" id="help-btn" class="help-btn" title="Raccourcis et aide">?</button>
        <button type="button" id="theme-btn" class="theme-btn" title="Th√®me clair / sombre">‚òÄ</button>
        <a href="{{ url_for('logout') }}" class="button logout-btn" title="Se d√©connecter">‚èª D√©connexion</a>
    </div>
    
    <div class="manga-cards" id="manga-cards">
        {% if not mangas %}
        <div class="empty-state">
            <div class="empty-state-icon">üìö</div>
            <h2>Aucun manga trouv√©</h2>
            <p>Modifiez les filtres ou ajoutez un nouveau manga pour commencer.</p>
            <button onclick="toggleForm()" class="button">Ajouter un manga</button>
        </div>
        {% else %}
        {% for manga in mangas %}
        <div class="manga-card" style="animation-delay: {{ loop.index0 * 0.06 }}s">
            {% if manga.non_lu %}
            <div class="badge-non-lu">Non lu depuis 1 semaine</div>
            {% endif %}
            <img src="{{ manga.image }}" alt="{{ manga.nom }}" loading="lazy" onerror="this.onerror=null; this.classList.add('img-fallback'); this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';">
            <div class="manga-details">
                <h3>{{ manga.nom }}</h3>
                <p class="chapter-row">Chapitre :</p>
                <div class="chapter-controls">
                    <button type="button" class="chapter-btn" onclick="modifierChapitre('{{ manga.id }}', -1)" aria-label="Diminuer le chapitre">‚àí</button>
                    <span id="chapitre-{{ manga.id }}">{{ manga.chapitre }}</span>
                    <button type="button" class="chapter-btn" onclick="modifierChapitre('{{ manga.id }}', 1)" aria-label="Augmenter le chapitre">+</button>
                </div>
                <p>Saison : {{ manga.saison }}</p>
                <p class="last-read" title="Derni√®re lecture">üìÖ {{ manga.last_read_label }}</p>
                <p>Statut : <span class="{{ 'status-termine' if manga.fini else 'status-cours' }}">{{ 'Termin√©' if manga.fini else 'En cours' }}</span></p>
                <p>
                    <a href="{{ url_for('lire_manga', id=manga.id) }}" target="_blank" class="link-read">Lire le manga</a>
                    <button type="button" class="copy-link-btn" data-url="{{ url_for('lire_manga', id=manga.id, _external=True) }}" onclick="copyReadLink(this)" title="Copier le lien">üìã</button>
                </p>
                <p>Note: {% for i in range(1, 6) %}
                    {% if i <= manga.note %}
                        &#9733;
                    {% else %}
                        &#9734;
                    {% endif %}
                {% endfor %}</p>
                <p><a href="{{ url_for('editer', id=manga.id) }}">Modifier</a> </p>
                <button class="delete-btn" onclick="supprimerManga('{{ manga.id }}')">Supprimer</button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

<!-- Modal confirmation suppression -->
<div id="delete-overlay" class="modal-overlay" aria-hidden="true">
<div id="delete-modal" class="modal confirm-modal">
    <h3>Supprimer ce manga ?</h3>
    <p>Cette action est irr√©versible.</p>
    <div class="modal-actions">
        <button type="button" class="button button-outline" onclick="closeDeleteModal()">Annuler</button>
        <button type="button" class="button delete-btn" onclick="confirmDelete()">Supprimer</button>
    </div>
</div>
</div>

<!-- Modal aide / raccourcis -->
<div id="help-overlay" class="modal-overlay" aria-hidden="true">
<div id="help-modal" class="modal help-modal">
    <span class="modal-close" id="close-help">&times;</span>
    <h3>Raccourcis & aide</h3>
    <ul>
        <li><kbd>N</kbd> Ouvrir / fermer le formulaire ¬´ Ajouter un manga ¬ª</li>
        <li><kbd>S</kbd> Focus sur la recherche</li>
        <li><kbd>√âchap</kbd> Fermer le panneau stats ou le formulaire</li>
        <li><strong>‚äû / ‚â°</strong> Vue grille ou liste (pr√©f√©rence enregistr√©e)</li>
        <li><strong>JSON / CSV</strong> T√©l√©charge une sauvegarde de ta liste</li>
        <li><strong>Filtres actifs</strong> Clique sur un tag √ó pour retirer ce filtre</li>
        <li><strong>Non lus 7j+</strong> Filtre les mangas non lus depuis au moins 7 jours</li>
        <li><strong>Ordre</strong> Ascendant / Descendant pour inverser le tri</li>
        <li><strong>‚òÄ / üåô</strong> Th√®me clair ou sombre (pr√©f√©rence enregistr√©e)</li>
    </ul>
</div>
</div>

<!-- Modal Ajouter un manga -->
<div id="add-overlay" class="modal-overlay" aria-hidden="true">
<div id="add-modal" class="modal add-manga-modal">
    <span class="modal-close add-close" onclick="toggleForm()" title="Fermer">&times;</span>
    <div class="add-manga-header">
        <span class="add-manga-icon">üìñ</span>
        <h2>Ajouter un manga</h2>
        <p>Remplis les informations de ton nouveau manga</p>
    </div>
    <form id="mangaForm" action="/ajouter" method="post" class="form-add-manga">
        <div class="form-add-grid">
            <div class="form-add-col">
                <label for="nom"><i class="fas fa-book"></i> Nom du manga</label>
                <input type="text" id="nom" name="nom" placeholder="Ex: One Piece" required>
                
                <label for="chapitre"><i class="fas fa-file"></i> Chapitre actuel</label>
                <input type="text" id="chapitre" name="chapitre" placeholder="Ex: 1050" required>
                
                <label for="saison"><i class="fas fa-layer-group"></i> Saison actuelle</label>
                <input type="text" id="saison" name="saison" placeholder="Ex: 1" required>
                
                <label for="fini"><i class="fas fa-check-circle"></i> Statut</label>
                <select id="fini" name="fini">
                    <option value="non">En cours</option>
                    <option value="oui">Termin√©</option>
                </select>
            </div>
            <div class="form-add-col">
                <label for="lien"><i class="fas fa-link"></i> Lien de lecture</label>
                <input type="url" id="lien" name="lien" placeholder="https://..." required>
                
                <label for="image"><i class="fas fa-image"></i> Lien de la couverture</label>
                <input type="url" id="image" name="image" placeholder="https://..." required>
                
                <label><i class="fas fa-star"></i> Note</label>
                <div class="stars stars-add">
                    <input type="radio" id="star5" name="note" value="5" />
                    <label for="star5"><i class="fas fa-star"></i></label>
                    <input type="radio" id="star4" name="note" value="4" />
                    <label for="star4"><i class="fas fa-star"></i></label>
                    <input type="radio" id="star3" name="note" value="3" />
                    <label for="star3"><i class="fas fa-star"></i></label>
                    <input type="radio" id="star2" name="note" value="2" />
                    <label for="star2"><i class="fas fa-star"></i></label>
                    <input type="radio" id="star1" name="note" value="1" />
                    <label for="star1"><i class="fas fa-star"></i></label>
                </div>
            </div>
        </div>
        <div class="form-add-actions">
            <button type="button" class="button button-outline" onclick="toggleForm()">Annuler</button>
            <button type="submit" class="button btn-submit-add">
                <i class="fas fa-plus"></i> Ajouter le manga
            </button>
        </div>
    </form>
</div>
</div>

<button id="stats-btn" title="Voir les statistiques">üìä</button>
<div id="stats-overlay">
    <div id="stats-panel">
        <span id="close-stats">&times;</span>
        <h2>Statistiques du site</h2>
        <div id="stats-content">
            <p><strong>Total de mangas :</strong> <span id="total"></span></p>
            <p><strong>Mangas termin√©s :</strong> <span id="finis"></span></p>
            <p><strong>Mangas en cours :</strong> <span id="en_cours"></span></p>
            <p><strong>Non lus depuis 7+ jours :</strong> <span id="non_lu_7j"></span></p>
            <p><strong>Total chapitres :</strong> <span id="total_chapitres"></span></p>
            <p><strong>Note moyenne :</strong> <span id="moyenne"></span></p>
            <p><strong>Meilleur manga :</strong> <span id="meilleur"></span></p>
        </div>
    </div>
</div>

<script>
  const statsBtn = document.getElementById('stats-btn');
  const overlay = document.getElementById('stats-overlay');
  const closeBtn = document.getElementById('close-stats');

  async function openStats() {
    try {
      const res = await fetch('/stats');
      if (!res.ok) throw new Error('Erreur r√©seau');
      const data = await res.json();
      document.getElementById('total').textContent = data.total ?? '0';
      document.getElementById('finis').textContent = data.finis ?? '0';
      document.getElementById('en_cours').textContent = data.en_cours ?? '0';
      document.getElementById('non_lu_7j').textContent = data.non_lu_7j ?? '0';
      document.getElementById('total_chapitres').textContent = data.total_chapitres ?? '0';
      document.getElementById('moyenne').textContent = data.moyenne ?? '0';
      document.getElementById('meilleur').textContent = (data.meilleur_nom ? `${data.meilleur_nom} (${data.meilleur_note}‚òÖ)` : '‚Äî');
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
    } catch (err) {
      console.error('Impossible de charger les stats :', err);
      alert("Impossible de r√©cup√©rer les statistiques. V√©rifie la route /stats c√¥t√© serveur.");
    }
  }

  statsBtn.addEventListener('click', openStats);
  closeBtn.addEventListener('click', () => {
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    if (document.getElementById('add-overlay').classList.contains('show')) {
      toggleForm();
      return;
    }
    if (document.getElementById('delete-overlay').classList.contains('show')) {
      closeDeleteModal();
      return;
    }
    if (document.getElementById('help-overlay').classList.contains('show')) {
      document.getElementById('help-overlay').classList.remove('show');
      return;
    }
    if (overlay.classList.contains('show')) {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }
  });

  // Toasts au chargement (apr√®s ajout / modification)
  (function() {
    var params = new URLSearchParams(window.location.search);
    var clean = false;
    if (params.get('added') === '1') {
      showToast('Manga ajout√©');
      params.delete('added');
      clean = true;
    }
    if (params.get('updated') === '1') {
      showToast('Modifications enregistr√©es');
      params.delete('updated');
      clean = true;
    }
    if (clean) {
      var q = params.toString();
      history.replaceState({}, '', window.location.pathname + (q ? '?' + q : ''));
    }
  })();

  // Raccourcis clavier
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey || e.altKey) return;
    var tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
    if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
    if (e.key === 'n' || e.key === 'N') {
      e.preventDefault();
      toggleForm();
    }
    if (e.key === 's' || e.key === 'S') {
      e.preventDefault();
      document.getElementById('search').focus();
    }
    if (e.key === 'Escape') {
      if (document.getElementById('add-overlay').classList.contains('show')) {
        toggleForm();
      }
    }
  });

  // Bascule vue grille / liste + sauvegarde pr√©f√©rence
  var viewKey = 'manga-view';
  var listEl = document.getElementById('manga-cards');
  function applyView(view) {
    var isList = view === 'list';
    listEl.classList.toggle('view-list', isList);
    document.querySelectorAll('.view-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-view') === view);
    });
    try { localStorage.setItem(viewKey, view); } catch (e) {}
  }
  try {
    var saved = localStorage.getItem(viewKey);
    if (saved === 'list' || saved === 'grid') applyView(saved);
  } catch (e) {}
  document.querySelectorAll('.view-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      applyView(btn.getAttribute('data-view'));
    });
  });

  // Modal aide
  document.getElementById('help-btn').addEventListener('click', function() {
    document.getElementById('help-overlay').classList.add('show');
  });
  document.getElementById('close-help').addEventListener('click', function() {
    document.getElementById('help-overlay').classList.remove('show');
  });
  document.getElementById('help-overlay').addEventListener('click', function(e) {
    if (e.target === document.getElementById('help-overlay')) {
      document.getElementById('help-overlay').classList.remove('show');
    }
  });

  document.getElementById('delete-overlay').addEventListener('click', function(e) {
    if (e.target === document.getElementById('delete-overlay')) closeDeleteModal();
  });
  document.getElementById('add-overlay').addEventListener('click', function(e) {
    if (e.target === document.getElementById('add-overlay')) toggleForm();
  });

  // Th√®me clair / sombre
  var themeKey = 'manga-theme';
  var themeBtn = document.getElementById('theme-btn');
  function applyTheme(light) {
    document.body.classList.toggle('theme-light', light);
    themeBtn.textContent = light ? 'üåô' : '‚òÄ';
    themeBtn.title = light ? 'Passer au th√®me sombre' : 'Passer au th√®me clair';
    try { localStorage.setItem(themeKey, light ? 'light' : 'dark'); } catch (e) {}
  }
  try {
    var t = localStorage.getItem(themeKey);
    applyTheme(t === 'light');
  } catch (e) {}
  themeBtn.addEventListener('click', function() {
    applyTheme(!document.body.classList.contains('theme-light'));
  });
</script>


</body>
</html>
